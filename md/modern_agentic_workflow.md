# 现代智能体工作流方案 (Modern Agentic Workflow)

## 1. 核心理念 (Core Philosophy)
将原有的“硬编码主循环”演进为“由 Trae 编排、Skill 驱动、Markdown 存储”的半自动外骨骼架构。通过降低代码复杂度，提升研究过程的可读性、干预性和鲁棒性。

## 2. 架构组成 (Architecture)

### 2.1 编排层 (Orchestration Layer)
- **调度器**：直接使用 **Trae IDE** 作为主控。
- **任务定义**：使用一系列结构化的 `.md` 提示词文件（SOP）引导 Trae 执行任务：
  - `方案规划.md`：负责研究思路拆解。
  - `事实填库.md`：负责信息采集与数据对齐。
  - `研判归因.md`：负责模式匹配与因果推导。

### 2.2 技能层 (Skill Layer)
将原工程的复杂逻辑封装为原子化的 **Skills**，供 Trae 直接调用。

#### **关键 Skills 列表：**
1. **SearchSkill**：调用 DeepSearch 或金融 API 获取原始数据。
2. **CrawlSkill**：针对特定 URL 进行网页爬取与清洗。
3. **VectorizeSkill**（核心增强）：
   - **输入**：文本片段、元数据（来源、标签）。
   - **操作**：调用 Embedding 模型生成向量；将向量存入本地索引（如 `.npz` 或 FAISS）；将文本与索引引用写入“事实库” Markdown 文件。
4. **RetrieveSkill**：
   - **操作**：基于 Query 检索向量库，返回最相关的文本片段及其对应的 Markdown 文件位置。
5. **ReportGenSkill**：基于收集到的事实块生成格式化的研报段落。

### 2.3 存储层 (Storage Layer / Fact Bank)
- **事实库 (Fact Bank)**：由一系列 Markdown 文件组成，代替原有的二进制 `memory.pkl`。
- **结构示例**：
  ```markdown
  # 事实条目: [ID]
  - **来源**: [URL]
  - **标签**: #营收 #2024财报
  - **向量引用**: `vec_store/item_001.vec`
  - **内容**: 
  > 商汤科技2024年上半年营收实现双位数增长...
  ```
- **优势**：人类可读、可手动修正、支持版本管理。

## 3. 向量化方案增强 (Vectorization Strategy)
向量化不再仅仅是内存中的缓存，而是作为**持久化过程**的一部分：
1. **增量向量化**：每当 `CrawlSkill` 采集到新信息，立即调用 `VectorizeSkill`。
2. **过程文件同步**：Markdown 文件中保留向量的 UUID 引用。
3. **透明检索**：当 Trae 执行“研判归因”时，它可以通过 `RetrieveSkill` 快速定位到散落在各个 MD 文件中的相关事实，而无需加载整个工程代码。

## 4. 方案优势 (Advantages)
1. **无需沙箱**：逻辑执行在 Trae 环境中，工具调用通过标准 API，极大降低了安全风险和维护成本。
2. **零代码干预**：研究员可以直接修改 `Fact Bank` 中的 Markdown 内容，修正 AI 的错误，向量索引随之更新。
3. **模块化解耦**：Skill 之间相互独立，可以随时更换更先进的搜索工具或 Embedding 模型。
4. **极致透明**：研究思路、数据采集、向量检索、归因推导全流程在 IDE 中可见。

## 5. 持久化与断线续作 (Persistence & Resumability)

### 5.1 任务级状态管理 (Task-Level State Management)
- **完成标记 (Completion Marker)**：每个子任务在 `Fact Bank` 中生成的 Markdown 事实文件即为该任务的“完成标记”。
- **智能体决策 (Agent-Driven)**：是否跳过某个子任务由**负责该任务的智能体**在调度前进行判断，而非 Skills 或工具。智能体会扫描过程文件，确认指标是否已达成，从而决定是发起调用还是直接引用现有结果。
- **幂等设计**：Skills 保持无状态 (Stateless) 和原子性，仅负责执行。智能体通过这种“检查-执行”模式实现整体流程的幂等。

### 5.2 状态恢复流程
1. **环境自检**：任务重新启动时，各级智能体首先通过 `ListFactsSkill` 或直接读取目录来感知当前的“事实库”现状。
2. **进度对齐**：智能体将已有的事实条目与其任务清单进行对齐，标记已完成节点。
3. **断点续作**：智能体仅对未标记为完成（即无对应事实文件）的子任务发起增量指令。


### 5.3 人机协同续作
- **手动补全**：允许研究员在中断期间手动创建或编辑 Markdown 事实文件。
- **无缝衔接**：系统重新启动后会自动感知手动修改，将其重新向量化并纳入后续的归因逻辑。

## 6. 参考提示词资产 (Reference Prompt Assets)

本方案核心逻辑由以下外部提示词 SOP 驱动，研究员可根据具体任务场景进行微调：

1. **[方案规划.md](file:///C:/logseq/investment/pages/提示词-商业分析-1-方案规划.md)**：
   - **作用**：定义研究范围、拆解关键财务/业务指标、规划信息采集路径。
2. **[事实填库.md](file:///C:/logseq/investment/pages/提示词-商业分析-2-事实填库.md)**：
   - **作用**：指导智能体执行具体采集任务，确保数据来源可靠且符合结构化存储要求。
3. **[研判归因.md](file:///C:/logseq/investment/pages/提示词-商业分析-3-研判归因.md)**：
   - **作用**：基于已填入的事实库，进行模式识别、因果推导及最终研报结论的产出。

