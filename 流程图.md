# FinSight 工程架构流程图

本文档详细描述了 FinSight 项目的整体业务逻辑、智能体协作、数据缓存机制以及底层模型提供方。

```mermaid
graph TD
    %% =======================
    %% 外部独立模型 (Infrastructure)
    %% =======================
    LLM_Provider[生成模型 LLM<br>负责规划、逻辑与写作]
    Embedding_Provider[嵌入模型 Embedding<br>负责文本向量化]
    VLM_Provider[视觉模型 VLM<br>负责图表审计]

    %% =======================
    %% 系统主流程
    %% =======================
    User[用户指令] -->|run_report.py| Init[系统初始化与任务规划]
    Init -.->|请求规划| LLM_Provider
    LLM_Provider -.->|返回任务列表| TaskQueue[任务池: 采集/分析/报告]

    subgraph MemorySystem
        GlobalState[("memory.pkl<br>数据总线与状态存取")]
        VectorIndex[向量索引<br>data2embedding 语义缓存]
    end

    Init -->|初始化| GlobalState

    %% 1. 采集阶段
    subgraph DataCollection
        Collector[DataCollector 智能体]
        Collector -->|调用| DeepSearch[DeepSearchAgent]
        Collector -->|调用| FinTools[金融数据工具集]
        DeepSearch -->|API| SearchAPI[Serper/Bocha/Bing]
        DeepSearch -->|爬虫| Crawler[Crawl4AI/Playwright]
        FinTools -->|接口| FinAPI[AkShare/eFinance/雪球]
    end

    TaskQueue -->|分配任务| Collector
    Collector -->|写入原始数据| GlobalState
    GlobalState -->|请求处理| Embedding_Provider
    Embedding_Provider -->|返回向量| VectorIndex

    %% 2. 分析阶段
    subgraph Analysis
        Analyzer[DataAnalyzer 智能体]
        Analyzer -.->|请求代码生成| LLM_Provider
        Analyzer -->|编写代码| Executor[AsyncCodeExecutor]
        Executor -->|执行绘图| Charts[数据图表]
    end

    GlobalState -->|读取数据| Analyzer
    Analyzer -.->|请求图像理解| VLM_Provider
    VLM_Provider -.->|返回修正建议| Analyzer
    Analyzer -->|写入分析结果| GlobalState

    %% 3. 报告生成阶段
    subgraph ReportGen
        Reporter[ReportGenerator 智能体]
        Reporter -.->|请求内容创作| LLM_Provider
        Reporter -->|语义检索| VectorIndex
        VectorIndex -->|召回素材| Reporter
        Reporter --> Outline[生成大纲]
        Outline --> Sections[撰写章节]
        Sections --> FinalDoc[Pandoc 转换 PDF/Word]
    end
```

## 核心架构说明

### 1. 独立模型层 (Independent Providers)
系统将 AI 能力抽象为三个独立的服务提供方，实现了业务逻辑与模型能力的解耦：
- **生成模型 (LLM)**: 作为全局逻辑大脑，负责任务规划、代码生成和最终的报告撰写。
- **嵌入模型 (Embedding)**: 专门负责非结构化文本的向量化，为语义检索提供底层支持。
- **视觉模型 (VLM)**: 专注于图表质量的自动化审计，确保生成的财务图表准确美观。

### 2. 多级缓存机制 (Multi-level Caching)
- **全局缓存**: `memory.pkl` 持久化存储整个系统的状态，确保任务可中断并恢复。
- **向量缓存**: `data2embedding` 存储已向量化的文本，避免重复调用 API。
- **环境缓存**: `state.dill` 记录 Python 解释器的变量状态，保证分析过程的连续性。

### 3. 数据与采集 (Data & Collection)
- **API 提供方**: 核心依赖 AkShare，涵盖了东财、新浪、金十等主流财经数据源。
- **爬虫提供方**: 整合了 Crawl4AI 和 Playwright，支持静态内容抓取与复杂的动态网页交互。
